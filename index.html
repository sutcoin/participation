<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ì£¼ì •ì‚°ê¸ˆ ìë°œì  ì¬ì°¸ì—¬</title>
  <link href="https://fonts.googleapis.com/css2?family=SUIT&display=swap" rel="stylesheet">
  <script type="module">
    // Firebase ì—°ë™
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, remove, set, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyByg8FeU-3woVufxnLoEMhi4t7-CRlS6BI",
      authDomain: "participation-4f85e.firebaseapp.com",
      databaseURL: "https://participation-4f85e-default-rtdb.firebaseio.com",
      projectId: "participation-4f85e",
      storageBucket: "participation-4f85e.appspot.com",
      messagingSenderId: "694493909568",
      appId: "1:694493909568:web:1ebf7b9394e2ddce3d05a5",
      measurementId: "G-6T8L975CVQ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // DOM ìš”ì†Œ ì°¸ì¡°
    const submitBtn = document.getElementById("submitBtn");
    const nicknameInput = document.getElementById("nickname");
    const groupInput = document.getElementById("group");
    const percentInput = document.getElementById("percent");
    const viewListBtn = document.getElementById("viewListBtn");
    const adminBtn = document.getElementById("adminBtn");
    const backBtn = document.getElementById("backBtn");
    const formContainer = document.getElementById("formContainer");
    const listContainer = document.getElementById("listContainer");
    const adminPanel = document.getElementById("adminPanel");
    const totalCount = document.getElementById("totalCount");
    const groupList = document.getElementById("groupList");
    const adminList = document.getElementById("adminList");
    const registerForm = document.getElementById("registerForm");
    const bulkInput = document.getElementById("bulkInput");
    const registerBtn = document.getElementById("registerBtn");
    const registerCloseBtn = document.getElementById("registerCloseBtn");
    const bulkFormBtn = document.getElementById("openRegisterForm");

    function normalizeGroup(group) {
      return group.replace(/\s/g, "");
    }

    submitBtn.onclick = () => {
      const nickname = nicknameInput.value.trim();
      const group = normalizeGroup(groupInput.value.trim());
      const percent = percentInput.value.trim();
      if (!nickname || !group || !percent) return alert("ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”.");
      push(ref(db, "participants"), { nickname, group, percent });
      nicknameInput.value = "";
      groupInput.value = "";
      percentInput.value = "";
      alert("ì‹ ì²­ ì™„ë£Œ!");
    };

    viewListBtn.onclick = () => {
      formContainer.style.display = "none";
      listContainer.style.display = "block";
      loadGroupedList();
    };

    backBtn.onclick = () => {
      formContainer.style.display = "flex";
      listContainer.style.display = "none";
      adminPanel.style.display = "none";
      registerForm.style.display = "none";
    };

    adminBtn.onclick = () => {
      const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸:");
      if (pw === "admin123") {
        formContainer.style.display = "none";
        adminPanel.style.display = "block";
        loadAdminList();
      } else {
        alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
      }
    };

    function loadGroupedList() {
      onValue(ref(db, "participants"), (snapshot) => {
        const data = snapshot.val() || {};
        const groups = {};
        Object.entries(data).forEach(([id, item]) => {
          const group = normalizeGroup(item.group);
          if (!groups[group]) groups[group] = [];
          groups[group].push(item);
        });

        // ê·¸ë£¹ ì •ë ¬
        const sorted = Object.entries(groups).sort((a, b) => b[1].length - a[1].length);

        let html = "";
        let total = 0;
        sorted.forEach(([group, people]) => {
          total += people.length;
          html += `<details><summary>${group} / ${people.length}</summary><ul>`;
          people.forEach(p => {
            html += `<li>${p.nickname} / ${p.percent}</li>`;
          });
          html += "</ul></details>";
        });

        groupList.innerHTML = html || "<p>ëª…ë‹¨ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
        totalCount.innerHTML = total;
      });
    }

    function loadAdminList() {
      onValue(ref(db, "participants"), (snapshot) => {
        const data = snapshot.val() || {};
        adminList.innerHTML = "";
        Object.entries(data).forEach(([id, item], idx) => {
          const div = document.createElement("div");
          div.innerHTML = `${idx + 1}. ${item.nickname} - ${item.group} - ${item.percent}
            <button onclick="deleteEntry('${id}')">ì‚­ì œ</button>
            <button onclick="editEntry('${id}', '${item.nickname}', '${item.group}', '${item.percent}')">ìˆ˜ì •</button>`;
          adminList.appendChild(div);
        });
      });
    }

    window.deleteEntry = (id) => {
      if (confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) remove(ref(db, `participants/${id}`));
    };

    window.editEntry = (id, nickname, group, percent) => {
      const newNickname = prompt("ë‹‰ë„¤ì„ ìˆ˜ì •", nickname);
      const newGroup = prompt("ì†Œì† ìˆ˜ì •", group);
      const newPercent = prompt("í¼ì„¼íŠ¸ ìˆ˜ì •", percent);
      if (newNickname && newGroup && newPercent) {
        update(ref(db, `participants/${id}`), {
          nickname: newNickname,
          group: normalizeGroup(newGroup),
          percent: newPercent
        });
      }
    };

    bulkFormBtn.onclick = () => {
      registerForm.style.display = "block";
    };

    registerCloseBtn.onclick = () => {
      registerForm.style.display = "none";
    };

    registerBtn.onclick = () => {
      const lines = bulkInput.value.trim().split("\n");
      lines.forEach(line => {
        const [nickname, group, percent] = line.split(",").map(s => s.trim());
        if (nickname && group && percent) {
          push(ref(db, "participants"), {
            nickname,
            group: normalizeGroup(group),
            percent
          });
        }
      });
      bulkInput.value = "";
      alert("ëª…ë‹¨ ë“±ë¡ ì™„ë£Œ!");
    };
  </script>
  <style>
    body {
      font-family: 'SUIT', sans-serif;
      background: #f1f1f1;
      margin: 0;
      padding: 20px;
    }
    h1, h2 {
      text-align: center;
    }
    .container {
      background: white;
      border-radius: 10px;
      padding: 20px;
      max-width: 500px;
      margin: 0 auto;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    input, textarea {
      width: 100%;
      padding: 10px;
      margin: 6px 0;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    button {
      padding: 10px;
      border: none;
      margin-top: 8px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }
    .green { background: #28a745; color: white; width: 100%; }
    .blue { background: #007bff; color: white; width: 100%; }
    .gray { background: #555; color: white; width: 100%; }
    .orange { background: orange; color: white; width: 100%; }
    #backBtn {
      position: absolute;
      top: 20px;
      left: 20px;
      background: #42a5f5;
      color: white;
      padding: 8px 14px;
      font-size: 14px;
    }
    summary {
      font-weight: bold;
      margin-top: 10px;
      cursor: pointer;
    }
    ul {
      padding-left: 20px;
    }
    details {
      margin-top: 10px;
    }
    .admin-btns button {
      margin-left: 10px;
    }
  </style>
</head>
<body>

  <button id="backBtn" style="display:none;">ë’¤ë¡œê°€ê¸°</button>

  <div class="container" id="formContainer">
    <h1>ì£¼ì •ì‚°ê¸ˆ ìë°œì  ì¬ì°¸ì—¬</h1>
    <input type="text" id="nickname" placeholder="ë‹‰ë„¤ì„">
    <input type="text" id="group" placeholder="ì†Œì† (ì˜ˆ: ëŒ€ì „ì„œêµ¬)">
    <input type="text" id="percent" placeholder="í¼ì„¼íŠ¸ (ì˜ˆ: 50)">
    <button class="green" id="submitBtn">ì‹ ì²­í•˜ê¸°</button>
    <button class="blue" id="viewListBtn">ì¬ì°¸ì—¬ ëª…ë‹¨ ë³´ê¸°</button>
    <button class="gray" id="adminBtn">ğŸ‘¤ ê´€ë¦¬ì ëª¨ë“œ</button>
  </div>

  <div class="container" id="listContainer" style="display:none;">
    <h2>ì†Œì†ë³„ ì°¸ì—¬ì í˜„í™©</h2>
    <p>í˜„ì¬ ì°¸ì—¬í•œ ì¸ì› <span style="color:red;font-weight:bold;" id="totalCount">0</span>ëª…</p>
    <div id="groupList"></div>
  </div>

  <div class="container" id="adminPanel" style="display:none;">
    <h2>ğŸ“‹ ì‹ ì²­ì ê´€ë¦¬</h2>
    <div id="adminList"></div>
    <button class="orange" id="openRegisterForm">ğŸ“¥ ëª…ë‹¨ ë“±ë¡</button>
  </div>

  <div class="container" id="registerForm" style="display:none;">
    <h2>ëª…ë‹¨ ì¼ê´„ ë“±ë¡</h2>
    <textarea rows="6" id="bulkInput" placeholder="ì˜ˆ: í™ê¸¸ë™, ëŒ€ì „ì„œêµ¬, 100"></textarea>
    <button class="orange" id="registerBtn">ë“±ë¡í•˜ê¸°</button>
    <button class="gray" id="registerCloseBtn">ë‹«ê¸°</button>
  </div>

</body>
</html>
