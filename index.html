<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ì£¼ì •ì‚°ê¸ˆ ìë°œì  ì¬ì°¸ì—¬</title>
  <link href="https://cdn.jsdelivr.net/gh/sunn-us/SUIT/fonts/static/woff2/SUIT.css" rel="stylesheet"/>

  <style>
    * { box-sizing: border-box; font-family: 'SUIT', sans-serif; }
    body {
      margin: 0;
      background: #f0f0f0;
      padding: 30px 10px;
      text-align: center;
    }
    h1 { font-size: 1.8em; margin-bottom: 20px; white-space: nowrap; }
    .container {
      max-width: 500px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 30px 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      position: relative;
    }
    input, textarea {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 1em;
    }
    .btn {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border-radius: 6px;
      border: none;
      font-weight: bold;
      font-size: 1em;
      cursor: pointer;
    }
    .btn-submit { background-color: #28a745; color: white; }
    .btn-view   { background-color: #007bff; color: white; }
    .btn-admin  { background-color: #343a40; color: white; }
    .btn-register { background-color: #ff9800; color: white; }

    .back-btn {
      background-color: #3fa9f5;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      font-weight: bold;
      font-size: 0.95em;
      position: absolute;
      top: 10px;
      left: 10px;
      cursor: pointer;
    }

    summary {
      font-weight: bold;
      margin-top: 10px;
      cursor: pointer;
    }
    ul { list-style: none; padding-left: 0; }
    li { margin: 4px 0; }

    #adminList { margin-top: 20px; text-align: left; }
    .admin-item { padding: 6px 0; border-bottom: 1px solid #ccc; }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getDatabase,
      ref,
      push,
      onValue,
      remove,
      set
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyByg8FeU-3woVufxnLoEMhi4t7-CRlS6BI",
      authDomain: "participation-4f85e.firebaseapp.com",
      databaseURL: "https://participation-4f85e-default-rtdb.firebaseio.com",
      projectId: "participation-4f85e",
      storageBucket: "participation-4f85e.appspot.com",
      messagingSenderId: "694493909568",
      appId: "1:694493909568:web:1ebf7b9394e2ddce3d05a5",
      measurementId: "G-6T8L975CVQ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let submissions = [];
    let submissionMap = {};

    function loadSubmissions(callback) {
      const submissionsRef = ref(db, 'submissions');
      onValue(submissionsRef, (snapshot) => {
        submissions = [];
        submissionMap = {};
        snapshot.forEach((childSnapshot) => {
          const item = childSnapshot.val();
          submissions.push(item);
          submissionMap[childSnapshot.key] = item;
        });
        if (callback) callback();
      });
    }

    // ---------------------- ì‹ ì²­í•˜ê¸° ----------------------
    window.submitForm = () => {
      const nickname = document.getElementById("nickname").value.trim();
      let group = document.getElementById("group").value.trim().replace(/\s/g, "");
      let percent = document.getElementById("percent").value.trim();

      if (!nickname || !group || !percent) {
        alert("ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }

      // â­ í¼ì„¼íŠ¸ ìë™ ì²˜ë¦¬: ìˆ«ìë§Œ ì…ë ¥í•˜ë©´ % ìë™ ì¶”ê°€
      if (!percent.includes("%")) {
        percent += "%";
      }

      const submission = { nickname, group, percent };
      push(ref(db, 'submissions'), submission);

      alert("ì‹ ì²­ ì™„ë£Œ!");
      document.getElementById("nickname").value = "";
      document.getElementById("group").value = "";
      document.getElementById("percent").value = "";
    };

    // ---------------------- ëª…ë‹¨ ë³´ê¸° ----------------------
    window.showCredits = () => {
      loadSubmissions(() => {
        document.getElementById("mainForm").style.display = "none";
        document.getElementById("creditScreen").style.display = "block";
        renderCredits();
      });
    };

    function renderCredits() {
      const creditText = document.getElementById("creditText");

      if (submissions.length === 0) {
        creditText.innerHTML = "<p>ëª…ë‹¨ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
        return;
      }

      const groups = {};
      submissions.forEach(item => {
        if (!groups[item.group]) groups[item.group] = [];
        groups[item.group].push(item);
      });

      const sortedGroups = Object.entries(groups).sort((a, b) => b[1].length - a[1].length);

      let html = `<p>í˜„ì¬ ì°¸ì—¬í•œ ì¸ì› <span style="color:red;font-size:1.3em">${submissions.length}</span>ëª…</p>`;
      sortedGroups.forEach(([group, list]) => {
        html += `<details>
                   <summary>${group} / ${list.length}</summary>
                   <ul>${list.map(p => `<li>${p.nickname} / ${p.percent}</li>`).join("")}</ul>
                 </details>`;
      });

      creditText.innerHTML = html;
    }

    // ---------------------- ë’¤ë¡œê°€ê¸° ----------------------
    window.goBack = () => {
      document.getElementById("mainForm").style.display = "block";
      document.getElementById("creditScreen").style.display = "none";
      document.getElementById("adminPanel").style.display = "none";
    };

    // ---------------------- ê´€ë¦¬ì ëª¨ë“œ ----------------------
    window.openAdminPanel = () => {
      const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
      if (pw !== "admin123") {
        alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
        return;
      }

      document.getElementById("mainForm").style.display = "none";
      document.getElementById("creditScreen").style.display = "none";
      document.getElementById("adminPanel").style.display = "block";

      loadSubmissions(renderAdminList);
    };

    function renderAdminList() {
      const list = document.getElementById("adminList");
      list.innerHTML = "";

      if (submissions.length === 0) {
        list.innerHTML = "<p>ì‹ ì²­ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
        return;
      }

      Object.entries(submissionMap).forEach(([id, item], index) => {
        const div = document.createElement("div");
        div.className = "admin-item";
        div.innerHTML = `
          ${index + 1}. ${item.nickname} - ${item.group} - ${item.percent}
          <button onclick="editEntry('${id}', '${item.nickname}', '${item.group}', '${item.percent}')">ìˆ˜ì •</button>
          <button onclick="deleteEntry('${id}')">ì‚­ì œ</button>
        `;
        list.appendChild(div);
      });
    }

    window.deleteEntry = (id) => {
      if (confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        remove(ref(db, `submissions/${id}`));
      }
    };

    window.editEntry = (id, nickname, group, percent) => {
      const newNickname = prompt("ë‹‰ë„¤ì„ ìˆ˜ì •:", nickname);
      const newGroup = prompt("ì†Œì† ìˆ˜ì •:", group);
      const newPercent = prompt("í¼ì„¼íŠ¸ ìˆ˜ì •:", percent);

      if (!newNickname || !newGroup || !newPercent) return;

      // ìˆ˜ì •í•  ë•Œë„ ìˆ«ìë§Œ ì…ë ¥í•˜ë©´ % ìë™ ì¶”ê°€
      let percentValue = newPercent.includes("%") ? newPercent : newPercent + "%";

      set(ref(db, `submissions/${id}`), {
        nickname: newNickname,
        group: newGroup.replace(/\s/g, ""),
        percent: percentValue
      });
    };

    window.registerBulkData = () => {
      const lines = document.getElementById("bulkInputArea").value.trim().split("\n");
      const submissionsRef = ref(db, "submissions");

      lines.forEach(line => {
        const [nickname, group, percent] = line.split(",").map(s => s.trim());
        if (nickname && group && percent) {
          let percentValue = percent.includes("%") ? percent : percent + "%";
          push(submissionsRef, { nickname, group, percent: percentValue });
        }
      });

      alert("ëª…ë‹¨ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
      document.getElementById("bulkInputArea").value = "";
    };
  </script>
</head>

<body>

  <h1>ì£¼ì •ì‚°ê¸ˆ ìë°œì  ì¬ì°¸ì—¬</h1>

  <!-- ë©”ì¸ ì‹ ì²­ í™”ë©´ -->
  <div class="container" id="mainForm">
    <input type="text" id="nickname" placeholder="ë‹‰ë„¤ì„">
    <input type="text" id="group" placeholder="ì†Œì†">
    <input type="text" id="percent" placeholder="í¼ì„¼íŠ¸">
    <button class="btn btn-submit" onclick="submitForm()">ì‹ ì²­í•˜ê¸°</button>
    <button class="btn btn-view" onclick="showCredits()">ì¬ì°¸ì—¬ ëª…ë‹¨ ë³´ê¸°</button>
    <button class="btn btn-admin" onclick="openAdminPanel()">ğŸ‘¤ ê´€ë¦¬ì ëª¨ë“œ</button>
  </div>

  <!-- ëª…ë‹¨ ë³´ê¸° í™”ë©´ -->
  <div class="container" id="creditScreen" style="display:none;">
    <button class="back-btn" onclick="goBack()">ë’¤ë¡œê°€ê¸°</button>
    <div id="creditText"></div>
  </div>

  <!-- ê´€ë¦¬ì íŒ¨ë„ -->
  <div class="container" id="adminPanel" style="display:none;">
    <button class="back-btn" onclick="goBack()">ë’¤ë¡œê°€ê¸°</button>
    <h3>ğŸ“‹ ì‹ ì²­ì ê´€ë¦¬</h3>
    <div id="adminList"></div>

    <h4>ğŸ“¥ ëª…ë‹¨ ì¼ê´„ ë“±ë¡</h4>
    <textarea id="bulkInputArea" rows="5" placeholder="ì˜ˆ: í™ê¸¸ë™, ëŒ€ì „ì„œêµ¬, 50"></textarea>
    <button class="btn btn-register" onclick="registerBulkData()">ëª…ë‹¨ ë“±ë¡</button>
  </div>

</body>
</html>
